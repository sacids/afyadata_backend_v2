{% extends 'layouts/base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load humanize %}

{% block content %}

<main class="bg-white h-full" id="form-rules">
  <div class="mx-auto max-w-7xl py-4 px-4 sm:px-6 lg:px-8">
    <!-- Card -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">

      <!-- Card Header -->
      <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200">
        <div>
          <h2 class="text-sm font-semibold text-gray-800">
            {{ title|default:"Select Clinical Signs" }}
          </h2>
          <p class="text-xs text-gray-500 mt-1">
            Search and tick the clinical signs
          </p>
        </div>
      </div>

      <!-- Card Body -->
      <div class="p-4">
        <div class="relative overflow-x-auto">
          <div id="message_wrp"></div>

          <form method="post" hx-encoding="multipart/form-data"
                hx-post="{% url 'projects:form-rules' survey.pk %}"
                hx-target="#message_wrp" enctype="multipart/form-data">

            {% csrf_token %}

            {# --- Autocomplete Search --- #}
            <div class="mb-4">
              <label for="sign_search" class="block text-sm font-medium text-gray-700 mb-1">
                Search clinical signs
              </label>

              <div class="relative">
                <input id="sign_search" type="text" autocomplete="off"
                       placeholder="Type to filter e.g. fever, cough..."
                       class="w-full rounded-sm border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-300" />
                <div class="pointer-events-none absolute right-3 top-2.5 text-gray-400 text-xs">
                  Ctrl+F
                </div>
              </div>

              <div class="mt-2 flex items-center justify-between text-xs text-gray-500">
                <span id="sign_count">Showing {{ clinical_signs|length }} items</span>
                <button type="button" id="clear_search" class="text-slate-700 hover:underline">
                  Clear
                </button>
              </div>
            </div>

            {# --- Clinical Signs Checkbox Grid (3 per row) --- #}
            <div class="border border-gray-200 rounded-sm p-3">
              <h3 class="text-sm font-semibold text-gray-800 mb-3">Clinical signs</h3>

              <div id="sign_grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                {% for sign in clinical_signs %}
                  {# Expected: sign.id, sign.name (adjust field names to your model) #}
                  <label class="clinical-sign flex items-start gap-2 rounded-sm border border-gray-100 p-2 hover:bg-gray-50"
                         data-name="{{ sign.name|lower }}">
                    <input type="checkbox"
                           name="clinical_signs"
                           value="{{ sign.id }}"
                           class="mt-1 h-4 w-4 rounded border-gray-300 text-slate-700 focus:ring-slate-400"
                           {% if selected_sign_ids and sign.id in selected_sign_ids %}checked{% endif %}
                    />
                    <span class="text-xs text-gray-700">
                      {{ sign.name }}
                    </span>
                  </label>
                {% empty %}
                  <div class="text-sm text-gray-500">
                    No clinical signs found.
                  </div>
                {% endfor %}
              </div>

              <div id="no_results" class="hidden mt-3 text-sm text-gray-500">
                No matching clinical signs.
              </div>
            </div>

            <!-- {# --- Optional: other fields from your form if you still want them --- #}
            {# 
            {% for field in form.visible_fields %}
              <div class="mb-3 mt-4">
                {{ field|as_crispy_field }}
              </div>
            {% endfor %}
            #} -->

            <div class="flex justify-end space-x-2 pt-4">
              <div class="space-x-1 px-1">
                <button type="button" hx-get="{% url 'projects:lists' %}" hx-target="body" hx-swap="outerHTML"
                        class="bg-white hover:bg-red-600 text-red-600 hover:text-white border border-red-600 text-sm font-normal py-2 px-3 rounded-sm">
                  Cancel
                </button>

                <button hx-post="{% url 'projects:form-rules' survey.pk %}" hx-target="#message_wrp"
                        type="button"
                        class="text-white bg-slate-700 border-slate-700 hover:bg-red-800 font-normal rounded-sm text-sm w-full sm:w-auto px-3 py-2 text-center">
                  Submit
                </button>
              </div>
            </div>

          </form>
        </div>
      </div>

    </div>
    <!-- End Card -->
  </div>
</main>

{% endblock %}

{% block extra-js %}
<script>
  $(document).ready(function () {
    htmx.process("#create-form");

    const $search     = $("#sign_search");
    const $clear      = $("#clear_search");
    const $items      = $(".clinical-sign");
    const $count      = $("#sign_count");
    const $noResults  = $("#no_results");

    function updateFilter() {
      const q = ($search.val() || "").trim().toLowerCase();
      let visible = 0;

      $items.each(function () {
        const name = ($(this).data("name") || "");
        const match = !q || name.includes(q);
        $(this).toggle(match);
        if (match) visible++;
      });

      $count.text(`Showing ${visible} items`);
      $noResults.toggleClass("hidden", visible !== 0);
    }

    $search.on("input", updateFilter);
    $clear.on("click", function () {
      $search.val("");
      updateFilter();
      $search.focus();
    });

    // initial
    updateFilter();
  });
</script>
{% endblock extra-js %}