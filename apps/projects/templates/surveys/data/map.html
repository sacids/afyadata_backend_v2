{% extends 'layouts/base.html' %}
{% load static %}
{% load humanize %}

{% block content %}

<main class="bg-white h-full">
    <div class="mx-auto max-w-7xl py-6 px-4 sm:px-6 lg:px-8">

        <!-- Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">

            <!-- Card Header -->
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200">
                <div>
                    <h2 class="text-sm font-semibold text-gray-800">
                        {{ title|default:'Data Map' }}
                    </h2>
                    <p class="text-xs text-gray-500">
                        Data maps
                    </p>
                </div>
            </div>

            <!-- Card Body -->
            <div class="flex flex-row flex-wrap">
                <div class="w-full p-4">
                    <div class="relative overflow-x-auto">
                        <div id="map" style="width: 100%; min-height:560px; height: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Card -->
    </div>
</main>

{% endblock %}

{% block extra-js %}
<script language="javascript">
    //create map
    const map = L.map('map').setView([-6.40177, 34.99269], 6);

    //create tileUrl and attribution
    const tileUrl = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';
    const attribution = '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>';

    //create tile
    const tile = L.tileLayer(tileUrl, {
        maxZoom: 19,
        attribution: attribution,
        id: 'mapbox/streets-v11'
    });

    //add tile to map
    tile.addTo(map);

    // 3. Fetch points from Django endpoint
    fetch("/projects/forms/points/" + "{{ cur_form.pk }}")
        .then(response => response.json())
        .then(points => {
            if (!Array.isArray(points)) return;

            const bounds = [];

            points.forEach(p => {
                if (typeof p.lat !== "number" || typeof p.lng !== "number") return;

                const marker = L.marker([p.lat, p.lng]).addTo(map);

                const popupHtml = `
                <strong>${p.title || 'No title'}</strong><br/>
                UUID: ${p.uuid || ''}<br/>
                Lat: ${p.lat.toFixed(5)}, Lng: ${p.lng.toFixed(5)}<br/>
                Created: ${p.created_at || ''}
            `;

                marker.bindPopup(popupHtml);
                bounds.push([p.lat, p.lng]);
            });

            // Zoom to fit all markers
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        })
        .catch(err => {
            console.error("Error loading form points:", err);
        });

    // map signature
    map.attributionControl.addAttribution('Sacids Foundation for One Health&copy; <a href="#">Afyadata</a>');
</script>
{% endblock extra-js %}