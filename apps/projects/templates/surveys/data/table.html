{% extends 'layouts/base.html' %}
{% load static %}
{% load humanize %}

{% block content %}

<main class="bg-white h-full" x-data="manageTable()" id="manageTable">
    <div class="mx-auto max-w-7xl py-4 px-4 sm:px-6 lg:px-8">
        <div class="flex flex-row flex-wrap">
            <div class="w-full">
                <div class="relative overflow-x-auto">
                    <table id="datatable" class="table border=1 w-full table-striped table-bordered compact nowrap text-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                {% for k,col in tbl_header.items %}
                                <th>{{col}}</th>
                                {% endfor %}
                                <th>Created on</th>
                                <th>Created By</th>
                                <th>Username</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
        <!-- /End replace -->
    </div>
</main>

{% endblock %}

{% block extra-js %}

<script language="javascript">
    $(document).ready(function() {
        var table = $('#datatable').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: "{{datatable_list}}",  // dynamic path with pk
                type: 'POST',
            },
            rowId: [0],
            order: [[ {{ tbl_header|length }} + 1, 'desc' ]],
            search: {
                return: true,
            },
            dom: `
                <"flex justify-between items-center py-2 border-b text-sm"
                    <"flex gap-2 items-center"B>
                    <"flex items-center"p>
                >
                t
            `,
            buttons: [
                {
                    extend: 'csv',
                    text: 'Download Data',
                    filename: 'Project-Data-csv',
                    className: 'bg-gray-500 text-white text-xs px-3 py-1 rounded hover:bg-gray-600'
                },
            ],
            "pageLength": 130,
            columnDefs: [
                {
                    render: function (data, type, row) {
                         return '<span @click="dataDetail(\''+data+'\')" class="cursor-pointer text-rose-900"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-3.5">'+
                             '<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />'+
                          '</svg><span>';
                    },
                    className: "bg-white hover:bg-rose-100",
                    targets: 0,
                },
                {
                     render: function (data, type, row) {
                         return '<span @click="dataDetail(\''+row[0]+'\')" class="cursor-pointer">'+data+'<span>';
                     },
                    targets: '_all',
                },
            ],

        });

        $('#Export').click(function(){
            table.button( '1' ).trigger();
        })

        $('#filter').click(function(){
            let search_val  = $('#datatable-search2').val()
            let min_date    = $('#min').val()
            let max_date    = $('#max').val()

            var obj         = new Object()
            obj.search_val  = search_val
            obj.min_date    = min_date
            obj.max_date    = max_date
            var jsonString  = JSON.stringify(obj);
            

            table.search(jsonString).draw()
            htmx.process('#manageTable')
        })

        htmx.process('#manageTable')

    });

    htmx.process('#manageTable')

    function manageTable(){
        return{

            sidebar_title: "",
            pg_actions_url: "",
            sidebarOpen: false,

            dataDetail(id){

                this.sidebar     = true;
                var title   = '<p class="text-md"> Survey Form '+id+'</p>';
                var url     = window.location.origin + '/ui/instance/' + id

                $('#sidebar-title').html(title);

                fetch(url)
                    .then(response => response.text())
                    .then(data => {
                        $('#data-detail').html(data)
                        htmx.process('#data-detail');
                    })
            },

            doPageAction(title,url){
                $('#sidebar-title').html(title);
                $('#data-detail').html(url);
            },

            

        }
    }

</script>
{% endblock extra-js %}