{% load static %}

<!-- Controls + Filters + Actions in 4-column grid -->
<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

    <!-- Left: Builder / filters -->
    <aside class="lg:col-span-4">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-5 py-4 border-b border-gray-200">
                <h2 class="text-sm font-semibold text-gray-800">Chart Builder</h2>
                <p class="text-xs text-gray-500">Choose x-axis, y-axis, and aggregation.</p>
            </div>

            <div class="p-5 space-y-5">
                <!-- Chart config -->
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">X-axis</label>
                        <select x-model="form.x_axis" title="x-axis"
                            class="w-full rounded-md border-gray-300 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <optgroup label="Form data fields">
                                <option value="">-- Select field --</option>
                                <template x-for="(field, index) in form_defn">
                                    <option x-bind:value="index" x-text="field"></option>
                                </template>
                            </optgroup>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Aggregate</label>
                        <select x-model="form.agg" title="agg"
                            class="w-full rounded-md border-gray-300 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="count">Count</option>
                            <option value="sum">Sum</option>
                            <option value="avg">Average</option>
                            <option value="max">Max</option>
                            <option value="min">Min</option>
                        </select>
                    </div>

                    <div x-show="form.agg !== 'count'" x-cloak>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Y-axis (numeric field)</label>
                        <select x-model="form.y_axis" title="y-axis"
                            class="w-full rounded-md border-gray-300 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">-- Select numeric field --</option>
                            <template x-for="(field, index) in form_defn">
                                <option x-bind:value="index" x-text="field"></option>
                            </template>
                        </select>
                    </div>
                </div>

                <!-- Filters -->
                <div class="pt-2 border-t border-gray-100">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs font-semibold text-gray-700">Filters</h3>
                        <button type="button" @click="resetFilters()" class="text-xs text-gray-500 hover:text-gray-700">
                            Reset
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">From</label>
                            <input type="date" x-model="form.date_from" title="date_from"
                                class="w-full rounded-md border-gray-300 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">To</label>
                            <input type="date" x-model="form.date_to" title="date_to"
                                class="w-full rounded-md border-gray-300 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="pt-2">
                    <button type="button" title="generate chart" @click="loadChart(activeFormId)" :disabled="loading"
                        class="w-full inline-flex justify-center items-center rounded-md bg-slate-700 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed">
                        <template x-if="!loading">
                            <span>Generate chart</span>
                        </template>
                        <template x-if="loading">
                            <span>Loadingâ€¦</span>
                        </template>
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Right: chart -->
    <section class="lg:col-span-8">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-5 py-4 border-b border-gray-200 flex items-center justify-between">
                <div>
                    <h2 class="text-sm font-semibold text-gray-800">Preview</h2>
                    <p class="text-xs text-gray-500" x-text="subtitle"></p>
                </div>

                <div class="flex gap-2">
                    <button type="button" @click="chartType='bar'; redraw()" class="text-xs px-3 py-1 rounded border"
                        :class="chartType==='bar' ? 'bg-gray-900 text-white border-gray-900' : 'bg-white text-gray-700 border-gray-300'">
                        Bar
                    </button>
                    <button type="button" @click="chartType='line'; redraw()" class="text-xs px-3 py-1 rounded border"
                        :class="chartType==='line' ? 'bg-gray-900 text-white border-gray-900' : 'bg-white text-gray-700 border-gray-300'">
                        Line
                    </button>
                </div>
            </div>

            <div class="p-5">
                <div class="relative">
                    <canvas id="chartCanvas" height="120"></canvas>
                </div>

                <div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-3">
                    <div class="rounded-md border border-gray-200 p-3">
                        <div class="text-xs text-gray-500">Points</div>
                        <div class="text-sm font-semibold text-gray-900" x-text="stats.points"></div>
                    </div>
                    <div class="rounded-md border border-gray-200 p-3">
                        <div class="text-xs text-gray-500">Total</div>
                        <div class="text-sm font-semibold text-gray-900" x-text="stats.total"></div>
                    </div>
                    <div class="rounded-md border border-gray-200 p-3">
                        <div class="text-xs text-gray-500">Max</div>
                        <div class="text-sm font-semibold text-gray-900" x-text="stats.max"></div>
                    </div>
                    <div class="rounded-md border border-gray-200 p-3">
                        <div class="text-xs text-gray-500">Min</div>
                        <div class="text-sm font-semibold text-gray-900" x-text="stats.min"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>